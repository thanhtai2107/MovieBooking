<!-- Edit Movie Modal -->
<div class="modal fade" id="editMovieModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMovieModalLabel">Edit Movie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img id="movieThumbnail" th:src="${movie.largeImage}" alt="Movie Thumbnail" class="movie-thumbnail">
                </div>
                <form id="editMovieForm" th:object="${movie}" th:action="@{/movies/update/{id}(id=${movie.movieId})}" method="post">
                    <input type="hidden" th:field="*{movieId}">
                    <div class="mb-3">
                        <label for="movieNameENG" class="form-label required-field">Movie name (ENG):</label>
                        <input type="text" class="form-control" id="movieNameENG" th:field="*{nameEnglish}" required>
                        <div class="invalid-feedback">Please enter the movie name in English.</div>
                    </div>
                    <div class="mb-3">
                        <label for="movieNameVN" class="form-label required-field">Movie name (VN):</label>
                        <input type="text" class="form-control" id="movieNameVN" th:field="*{nameVN}" required>
                        <div class="invalid-feedback">Please enter the movie name in Vietnamese.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fromDate" class="form-label required-field">From date:</label>
                        <input type="date" class="form-control" id="fromDate" name="fromDate" th:value="${#temporals.format(movie.fromDate, 'yyyy-MM-dd')}" required>
                        <div class="invalid-feedback">Please select a valid from date.</div>
                    </div>
                    <div class="mb-3">
                        <label for="toDate" class="form-label required-field">To date:</label>
                        <input type="date" class="form-control" id="toDate" name="toDate" th:value="${#temporals.format(movie.toDate, 'yyyy-MM-dd')}" required>
                        <div class="invalid-feedback">Please select a valid to date.</div>
                    </div>
                    <div class="mb-3">
                        <label for="actor" class="form-label required-field">Actor:</label>
                        <input type="text" class="form-control" id="actor" th:field="*{actor}" required>
                    </div>
                    <div class="mb-3">
                        <label for="productionCompany" class="form-label required-field">Movie Production Company:</label>
                        <input type="text" class="form-control" id="productionCompany" th:field="*{productionCompany}" required>
                    </div>
                    <div class="mb-3">
                        <label for="director" class="form-label required-field">Director:</label>
                        <input type="text" class="form-control" id="director" th:field="*{director}" required>
                    </div>
                    <div class="mb-3">
                        <label for="duration" class="form-label required-field">Duration:</label>
                        <input type="number" class="form-control" id="duration" th:field="*{duration}" required>
                    </div>
                    <div class="mb-3">
                        <label for="version" class="form-label required-field">Version:</label>
                        <input type="text" class="form-control" id="version" th:field="*{version}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Movie Types:</label>
                        <div id="movieTypes">
                            <div th:each="type : ${allTypes}" class="form-check">
                                <input type="checkbox" th:id="'type' + ${type.typeId}" th:value="${type.typeId}" name="movieTypes" class="form-check-input"
                                       th:checked="${movie.movieTypeList != null && movie.movieTypeList.![type.typeId].contains(type.typeId)}">
                                <label th:for="'type' + ${type.typeId}" th:text="${type.typeName}" class="form-check-label"></label>
                            </div>
                        </div>
                        <div class="invalid-feedback">Please select at least one movie type.</div>
                    </div>
                    <div class="mb-3">
                        <label for="cinemaRoom" class="form-label">Cinema room:</label>
                        <select id="cinemaRoom" name="cinemaRoom.cinemaRoomId" class="form-select">
                            <option th:each="room : ${cinemaRooms}" 
                                    th:value="${room.cinemaRoomId}" 
                                    th:text="${room.cinemaName}"
                                    th:selected="${movie.cinemaRoom != null and movie.cinemaRoom.cinemaRoomId == room.cinemaRoomId}">
                            </option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedules:</label>
                        <div id="schedules">
                            <div th:each="schedule : ${schedules}" class="form-check">
                                <input type="checkbox" th:id="'schedule' + ${schedule.scheduleId}" 
                                       th:value="${schedule.scheduleId}" 
                                       name="schedules" 
                                       class="form-check-input"
                                       th:checked="${movie.movieScheduleList != null && movie.movieScheduleList.![schedule.scheduleId].contains(schedule.scheduleId)}">
                                <label th:for="'schedule' + ${schedule.scheduleId}" th:text="${schedule.scheduleTime}" class="form-check-label"></label>
                            </div>
                        </div>
                        <div class="invalid-feedback">Please select at least one schedule.</div>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content:</label>
                        <textarea class="form-control" id="content" th:field="*{content}" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="largeImage" class="form-label">Image URL:</label>
                        <input type="file" class="form-control" id="largeImage" th:field="*{largeImage}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="editMovieForm" class="btn btn-primary">Update</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
$(document).ready(function() {
    $('#editMovieForm').submit(function(e) {
        e.preventDefault();
        if (validateForm()) {
            submitForm();
        }
    });

    function validateForm() {
        let isValid = true;
        
        // Check required fields
        $('#editMovieForm input[required], #editMovieForm textarea[required]').each(function() {
            if ($(this).val().trim() === '') {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // Check if at least one movie type is selected
        if ($('input[name="movieTypes"]:checked').length === 0) {
            isValid = false;
            $('#movieTypes').addClass('is-invalid');
        } else {
            $('#movieTypes').removeClass('is-invalid');
        }

        // Check if at least one schedule is selected
        if ($('input[name="schedules"]:checked').length === 0) {
            isValid = false;
            $('#schedules').addClass('is-invalid');
        } else {
            $('#schedules').removeClass('is-invalid');
        }

        // Check if From date is not later than To date
        const fromDate = new Date($('#fromDate').val());
        const toDate = new Date($('#toDate').val());
        if (fromDate > toDate) {
            isValid = false;
            $('#fromDate').addClass('is-invalid');
            $('#toDate').addClass('is-invalid');
        } else {
            $('#fromDate').removeClass('is-invalid');
            $('#toDate').removeClass('is-invalid');
        }

        return isValid;
    }

    function submitForm() {
        var form = $('#editMovieForm');
        var formData = new FormData(form[0]);
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#editMovieModal').modal('hide');
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('Error updating movie:', xhr.responseText);
                // Error handling is now done through form validation
            }
        });
    }

    // Add image error handling
    $('#movieThumbnail').on('error', function() {
        $(this).attr('src', 'https://via.placeholder.com/300x450.png?text=No+Image');
    });
});
</script>