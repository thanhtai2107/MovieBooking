<!-- Add Movie Modal -->
<div class="modal fade" id="addMovieModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovieModalLabel">Add New Movie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img id="movieThumbnail" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/1665px-No-Image-Placeholder.svg.png" alt="Movie Thumbnail" class="movie-thumbnail">
                </div>
                <form id="addMovieForm">
                    <div class="mb-3">
                        <label for="movieNameENG" class="form-label required-field">Movie name (ENG):</label>
                        <input type="text" class="form-control" id="movieNameENG" name="nameEnglish" required>
                        <div class="invalid-feedback">Please enter the movie name in English.</div>
                    </div>
                    <div class="mb-3">
                        <label for="movieNameVN" class="form-label required-field">Movie name (VN):</label>
                        <input type="text" class="form-control" id="movieNameVN" name="nameVN" required>
                        <div class="invalid-feedback">Please enter the movie name in Vietnamese.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fromDate" class="form-label required-field">From date:</label>
                        <input type="date" class="form-control" id="fromDate" name="fromDate" required>
                        <div class="invalid-feedback">Please select a valid from date.</div>
                    </div>
                    <div class="mb-3">
                        <label for="toDate" class="form-label required-field">To date:</label>
                        <input type="date" class="form-control" id="toDate" name="toDate" required>
                        <div class="invalid-feedback">Please select a valid to date.</div>
                    </div>
                    <div class="mb-3">
                        <label for="actor" class="form-label required-field">Actor:</label>
                        <input type="text" class="form-control" id="actor" name="actor" required>
                        <div class="invalid-feedback">Please enter the actor's name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="productionCompany" class="form-label required-field">Movie Production Company:</label>
                        <input type="text" class="form-control" id="productionCompany" name="productionCompany" required>
                        <div class="invalid-feedback">Please enter the production company.</div>
                    </div>
                    <div class="mb-3">
                        <label for="director" class="form-label required-field">Director:</label>
                        <input type="text" class="form-control" id="director" name="director" required>
                        <div class="invalid-feedback">Please enter the director's name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="duration" class="form-label required-field">Duration:</label>
                        <input type="number" class="form-control" id="duration" name="duration" required>
                        <div class="invalid-feedback">Please enter the movie duration.</div>
                    </div>
                    <div class="mb-3">
                        <label for="version" class="form-label required-field">Version:</label>
                        <input type="text" class="form-control" id="version" name="version" required>
                        <div class="invalid-feedback">Please enter the movie version.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type:</label>
                        <div id="movieTypes">
                            <div class="form-check" th:each="type : ${types}">
                                <input class="form-check-input" type="checkbox" th:id="${'type-' + type.typeId}" name="movieTypes" th:value="${type.typeId}">
                                <label class="form-check-label" th:for="${'type-' + type.typeId}" th:text="${type.typeName}"></label>
                            </div>
                        </div>
                        <div class="invalid-feedback">Please select at least one movie type.</div>
                    </div>
                    <div class="mb-3">
                        <label for="cinemaRoom" class="form-label">Cinema room:</label>
                        <select id="cinemaRoom" name="cinemaRoom" class="form-select">
                            <option value="" selected disabled>Choose a cinema room</option>
                            <option th:each="room : ${cinemaRooms}" th:value="${room.cinemaRoomId}" th:text="${room.cinemaName}"></option>
                        </select>
                        <div class="invalid-feedback">Please select a cinema room.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedule:</label>
                        <div id="schedules">
                            <div th:each="schedule : ${schedules}" class="form-check">
                                <input type="checkbox" th:id="'schedule' + ${schedule.scheduleId}" th:value="${schedule.scheduleId}" name="schedules" class="form-check-input">
                                <label th:for="'schedule' + ${schedule.scheduleId}" th:text="${schedule.scheduleTime}" class="form-check-label"></label>
                            </div>
                        </div>
                        <div class="invalid-feedback">Please select at least one schedule.</div>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content:</label>
                        <textarea class="form-control" id="content" name="content" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="largeImage" class="form-label">Image URL:</label>
                        <input type="url" class="form-control" id="largeImage" name="largeImage">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveNewMovie">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('#addMovieForm').submit(function(e) {
        e.preventDefault(); // Prevent default form submission
        if (validateForm()) {
            submitForm();
        }
    });

    function validateForm() {
        let isValid = true;
        
        // Check required fields
        $('#addMovieForm input[required], #addMovieForm textarea[required]').each(function() {
            if ($(this).val().trim() === '') {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // Check if a cinema room is selected
        if ($('#cinemaRoom').val() === null || $('#cinemaRoom').val() === "") {
            isValid = false;
            $('#cinemaRoom').addClass('is-invalid');
        } else {
            $('#cinemaRoom').removeClass('is-invalid');
        }

        // Check if at least one movie type is selected
        if ($('input[name="movieTypes"]:checked').length === 0) {
            isValid = false;
            $('#movieTypes').addClass('is-invalid');
        } else {
            $('#movieTypes').removeClass('is-invalid');
        }

        // Check if at least one schedule is selected
        if ($('input[name="schedules"]:checked').length === 0) {
            isValid = false;
            $('#schedules').addClass('is-invalid');
        } else {
            $('#schedules').removeClass('is-invalid');
        }

        // Check if From date is not later than To date
        const fromDate = new Date($('#fromDate').val());
        const toDate = new Date($('#toDate').val());
        if (fromDate > toDate) {
            isValid = false;
            $('#fromDate').addClass('is-invalid');
            $('#toDate').addClass('is-invalid');
        } else {
            $('#fromDate').removeClass('is-invalid');
            $('#toDate').removeClass('is-invalid');
        }

        return isValid;
    }

    function submitForm() {
        var form = $('#addMovieForm');
        var formData = new FormData(form[0]);
        
        // Disable the submit button
        $('#saveNewMovie').prop('disabled', true);
        
        $.ajax({
            url: '/movies/create',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#addMovieModal').modal('hide');
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('Error creating movie:', xhr.responseText);
                // Handle error (e.g., show error message to user)
            },
            complete: function() {
                // Re-enable the submit button
                $('#saveNewMovie').prop('disabled', false);
            }
        });
    }

    // Add image error handling
    $('#movieThumbnail').on('error', function() {
        $(this).attr('src', 'https://via.placeholder.com/300x450.png?text=No+Image');
    });
});
</script>